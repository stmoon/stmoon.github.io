<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Fake GPS</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../favicon.ico">

    <link rel="stylesheet" type="text/css" href="../assets/css/screen.css?v=bd325a5265">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic%7COpen+Sans:700,400">

    <link rel="canonical" href="index.html">
    <meta name="referrer" content="origin">
    
    <meta property="og:site_name" content="Program Lock">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Fake GPS">
    <meta property="og:description" content="Introduction 안녕하세요. 오늘은 Fake GPS에 대해 알아보고자 합니다.  사실 Fake GPS는 Pixhawk에서 시험을 위해 미리 정해놓은 GPS 위치를 가르킵니다. 설정에서 GPS_FAKE를 yes로 설정하면 Fake GPS를 사용할 수 있죠. 하지만, 픽스호크 개발자 사이트에 가보시면 모션 캡쳐 시스템과 연동을 하여 GPS 상태를 모사하는 것을 가르키고 있네요. 아직 정의가 조금은 모호하지만, 어찌되었든">
    <meta property="og:url" content="http://localhost:2368/fake-gps/">
    <meta property="article:published_time" content="2016-03-06T13:35:25.359Z">
    <meta property="article:modified_time" content="2016-03-08T06:13:05.843Z">
    <meta property="article:tag" content="pixhawk">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Fake GPS">
    <meta name="twitter:description" content="Introduction 안녕하세요. 오늘은 Fake GPS에 대해 알아보고자 합니다.  사실 Fake GPS는 Pixhawk에서 시험을 위해 미리 정해놓은 GPS 위치를 가르킵니다. 설정에서 GPS_FAKE를 yes로 설정하면 Fake GPS를 사용할 수 있죠. 하지만, 픽스호크 개발자 사이트에 가보시면 모션 캡쳐 시스템과 연동을 하여 GPS 상태를 모사하는 것을 가르키고 있네요. 아직 정의가 조금은 모호하지만, 어찌되었든">
    <meta name="twitter:url" content="http://localhost:2368/fake-gps/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="SungTae Moon">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="pixhawk">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Program Lock",
        "logo": "http://localhost:2368/ghost/img/ghosticon.jpg"
    },
    "author": {
        "@type": "Person",
        "name": "SungTae Moon",
        "image": "http://localhost:2368/content/images/2016/03/140901_drone_writer_hei-100x113-1.jpg",
        "url": "http://localhost:2368/author/sungtae/",
        "sameAs": []
    },
    "headline": "Fake GPS",
    "url": "http://localhost:2368/fake-gps/",
    "datePublished": "2016-03-06T13:35:25.359Z",
    "dateModified": "2016-03-08T06:13:05.843Z",
    "keywords": "pixhawk",
    "description": "Introduction 안녕하세요. 오늘은 Fake GPS에 대해 알아보고자 합니다.  사실 Fake GPS는 Pixhawk에서 시험을 위해 미리 정해놓은 GPS 위치를 가르킵니다. 설정에서 GPS_FAKE를 yes로 설정하면 Fake GPS를 사용할 수 있죠. 하지만, 픽스호크 개발자 사이트에 가보시면 모션 캡쳐 시스템과 연동을 하여 GPS 상태를 모사하는 것을 가르키고 있네요. 아직 정의가 조금은 모호하지만, 어찌되었든"
}
    </script>

    <meta name="generator" content="Ghost 0.8">
    <link rel="alternate" type="application/rss+xml" title="Program Lock" href="../rss/index.html">
</head>
<body class="post-template tag-pixhawk nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="index.html#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
            <li class="nav-home" role="presentation"><a href="../">Home</a></li>
            <li class="nav-admin" role="presentation"><a href="http://localhost:2368/ghost/">admin</a></li>
            <li class="nav-pixhawk" role="presentation"><a href="../tag/pixhawk/">Pixhawk</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="../rss/index.rss">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
            <a class="menu-button icon-menu" href="index.html#"><span class="word">Menu</span></a>
    </nav>
</header>

<main class="content" role="main">
    <article class="post tag-pixhawk">

        <header class="post-header">
            <h1 class="post-title">Fake GPS</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2016-03-06">06 March 2016</time>  on <a href="../tag/pixhawk/">pixhawk</a>
            </section>
        </header>

        <section class="post-content">
            <h4 id="introduction">Introduction</h4>

<p>안녕하세요. 오늘은 Fake GPS에 대해 알아보고자 합니다. </p>

<p>사실 Fake GPS는 Pixhawk에서 시험을 위해 미리 정해놓은 GPS 위치를 가르킵니다. 설정에서 GPS_FAKE를 yes로 설정하면 Fake GPS를 사용할 수 있죠. 하지만, 픽스호크 개발자 사이트에 가보시면 모션 캡쳐 시스템과 연동을 하여 GPS 상태를 모사하는 것을 가르키고 있네요. 아직 정의가 조금은 모호하지만, 어찌되었든 저희는 후자의 Fake GPS에 대해 알아보고자 합니다. </p>

<p>우선 개발 환경부터 알려드릴게요</p>

<blockquote>
  <ul>
  <li>Ubuntu 14.04</li>
  <li>Motion Capture (VICON)</li>
  <li>Indigo ROS</li>
  <li>MAVROS, vicon_bridge</li>
  </ul>
</blockquote>

<p>Fake GPS를 위해서는 가장 중요한 것은 모션 캡쳐가 있어야 한다는 거지요. 물론 모션 캡쳐가 매우 비싸기 때문에 일반인이 개인적으로 소유하기는 힘들겠지만, 연구실에서는 점차 많이 사용하고 있는것 같습니다. 따라서, 본 문서는 모션 캡쳐가 있다는 가정하에 말씀드리도록 하겠습니다. 참고로 이 문서에서는 모션 캡쳐로 VICON을 사용했지만, ROS에서 지원하는 다른 모션 캡쳐도 얼마든지 사용 가능합니다.</p>

<h4 id="ros">ROS</h4>

<p>ROS가 뭐냐구요? ROS를 모르시는 분들이 계실 것 같아 간단하게 설명하겠습니다. ROS는 robot operating system의 약어입니다. 운영체제? 저도 처음에는 리눅스와 같은 운영체제인줄 알았지요. 하지만, ros.org에서 설명하는 글을 읽어보면 분명 운영체제가 아님을 알 수 있습니다.</p>

<blockquote>
  <p>The Robot Operating System (ROS) is a flexible framework for writing robot software. It is a collection of tools, libraries, and conventions that aim to simplify the task of creating complex and robust robot behavior across a wide variety of robotic platforms.</p>
</blockquote>

<p>제가 생각하는 ROS란, 쉽게 얘기하면 툴박스와 같은 개념이라고 보시면 될 것 같습니다. 그런데 거기에 많은 개발자들이 정보를 공유하다 보니, 왠만한 센서들의 드라이버 등등이 있고, 어느 정도 프로토콜이 확정되어 있다보니, 여러가지 툴들을 활용하여 내부 데이터 흐름이라든지, 시각화하는 것을 쉽게 할 수 있게 되는 거지요. 결국 중요한 것은 하나의 시스템을 만들기 위해 필요한 잡다한 것을 ROS가 제공한다는 것입니다. 이렇게 되면 무엇보다도 시스템을 만드는 시간이 절약되고, 그 시간에 내가 연구하는 부분에 집중할 수 있게 되지요.</p>

<p><img src="../content/images/2016/03/ROS.png" alt="ROS"></p>

<p>우리나라에서도 표윤석 박사님, 이지훈 연구원님과 같은 최고 전문가들이 있고, 오로카라는 네이버 카페에서 많은 활동들이 이루어지고 있으니, 참고하시길 바랍니다. 나중에 기회가 되면 좀더 자세히 설명하도록 하겠습니다.</p>

<p>사실 ROS는 로봇 분야에서 시작되었지만, 지금은 정말 다양한 분야에서 활용이 되는 것 같습니다. 제가 연구하고 있는 드론분야에서도 정말 많이 활용되지요. 특히, 제가 여러분들에게 자주 설명할 Pixhawk는 ROS와 정말 많이 닮아 있습니다. 그게 바로 publisher-subscriber design pattern인데, ROS와 Pixhawk의 내부 IPC(Inter-Process Communication)는 이 방법을 그대로 적용했답니다. 이렇게 닮은 꼴을 갖고 있는 이유는 뭘까요? 그것은 초기 Pixhawk가 개발되고 있을때 주 개발자였던 Lorenz Meier가 처음부터 ROS와 연동을 고려하고 있었기 때문이지요. 이런 이유로 ROS와 Pixhawk는 연동이 잘 됩니다.!!</p>

<p><img src="../content/images/2016/03/ROS_milestone.png" alt="ROS MileStone"></p>

<h4 id="prerequisites">Prerequisites</h4>

<p>그러면 그럼 이제 각설하고, 본격적으로 어떻게 Fake GPS를 구동하는지 구체적으로 살펴보도록 하겠습니다. 우선 ROS가 설치된 컴퓨터가 필요합니다. 앞에서 말씀드린 것 처럼 ROS는 Indigo를 사용했습니다. 그리고 나서 MAVROS와 Vicon_bridge를 설치합니다. 설치하는 방법은 ros 홈페이지가보시면 상세히 잘 나와있습니다.</p>

<ul>
<li>MAVROS</li>
<li>Vicon_bridge</li>
</ul>

<h4 id="step1">Step 1</h4>

<p>앞에서 설명했던 것 처럼 Fake GPS는 ROS 기반으로 동작합니다. 따라서 ROS가 동작할 만한 판을 만들어 주어야 합니다.이는 ROS를 처음 사용할 시에는 무조건 해주어야 하는건데, 이를 통해 ROS의 각 노드들이 통신할 수 있게 되지요.</p>

<pre><code>$ roscore
</code></pre>

<p><img src="../content/images/2016/03/FakeGPS_step1.png" alt=""></p>

<h4 id="step2">Step 2</h4>

<p>이제 ROS를 동작할 수 있는 기반이 만들어졌고, 본격적으로 FakeGPS 환경을 만들어봅시다. 먼저 모션캡쳐와 연동을 해야 합니다. 모션 캡쳐로부터 드론의 6 DOF를 받야아 하는데, ROS에서 이미 개발된 vicon_bridge를 사용하도록 하겠습니다. 이를 사용하면 vicon으로부터 특정 드론에 붙어 있는 마커를 통해 특정 패턴 정보를 받아 볼 수 있게 됩니다.</p>

<pre><code>$ sh launch_fake_gps.sh
</code></pre>

<p><img src="../content/images/2016/03/FakeGPS_step2.png" alt=""></p>

<h4 id="step3">Step 3</h4>

<pre><code>sh launch_fake_gps_distorted.sh  
</code></pre>

<p>이후, 실제 GPS 신호인 것 처럼 만들어 줍니다. 사실 모션 캡쳐는 최대 1000 Hz까지도 동작하지만, Pixhawk에서는 주로 GPS 신호를 5 Hz로 받고 있습니다. 따라서, 데이터 갱신 주기를 변경해 주어야 합니다. 그리고 모션 캡쳐는 1 mm 이하의 정확도로 측정이 가능한데, 실제 GPS는 오차가 매우 크기 때문에  white noise와 같은 노이즈 성분을 추가하여 GPS 상황과 유사하게 만들어 줍니다. 그리고 GPS는 지연 시간이 있기 때문에 지연 시간 또한 만들어줍니다. 이런 모든 것은 ROS에서 제공하는 ros_reconfigure 툴을 사용하여 수정이 가능하니, 외부에 나가 GPS신호에 대해 대략 분석해보고 좋을 때 나쁠 때의 상황을 재현할 수 있게 되는 거지요. 이게 결국 Fake GPS를 만들어주는 중요한 뽀인트 중 하나일 것 같군요.</p>

<pre><code>$ rosrun rqt_reconfigure rqt_reconfigure
</code></pre>

<blockquote>
  <ul>
  <li>publish rate = 5.0Hz</li>
  <li>tf<em>frame</em>in = vicon/yourModelName/yourModelName (e.g. </li>
  <li>vicon/DJI<em>450/DJI</em>450)</li>
  <li>delay = 200ms</li>
  <li>sigma_xy = 0.05m</li>
  <li>sigma_z = 0.05m</li>
  </ul>
</blockquote>

<p><img src="../content/images/2016/03/FakeGPS_step3.png" alt=""></p>

<h4 id="step4">Step 4</h4>

<p>이제 Pixhawk를 Fake GPS가 연동 될 수 있도록 만들어주어야 할 때가 왔군요. Pixhawk는 내부에 Param 형태로 설정값을 변경할 수 있도록 되어 있습니다. 이 또한 ROS와 비슷하네요. 아무리 봐도 Lorenz Meier는 분명 ROS 매니아 였거나 그동안 많이 사용해보았던 흔적들이 보입니다. 나중에 한번 역추적해보도록 하겠습니다. 
자 어찌 되었든, 크게 세가지 부분을 변경해야 합니다. 첫째, MAV_USEHILGPS입니다. </p>

<pre><code>MAV_USEHILGPS to 1 (enable HIL GPS, go to PARAMETERS-&gt;MAVLink)  
</code></pre>

<p>이 부분을 enable시켜주면 HILS에서 생성된 GPS를 사용하겠다는 의미입니다. 그런데 약간 문제가 있습니다. 모션캡쳐가 설치된 환경에서도 가끔씩 GPS 신호가 약하게 잡히는 경우가 있다는 점입니다. 아마 해보시면, 그런 문제가 생길 수 있을 것입니다.  결국 이렇게 되면 GPS 신호가 두군데에서 들어오게 되고, Pixhawk 내부에서는 엄청난 혼란에 빠지게 됩니다. 특히, 이를 사용하여 드론의 속도등을 계산하게 되는데, 실제 신호는 한국으로 되어 있고, FakeGPS 신호는 스위스를 기반으로 두고 있다면, 드론 입장에서는 워프가 발생하는 거지요. 이 문제에 대해서는 수정 사항을 코드에 업데이트 하고 있습니다. 아마 버전 1.3.0에 적용될 예정이니 참고하세요 </p>

<pre><code>ATT_EXT_HDG_M to 2 (use heading from motion capture, go to PARAMETERS-&gt;Attitude Q estimator)  
</code></pre>

<p>두번째는 드론의 헤딩 정보를 모션캡쳐로 부터 오는 데이터로 변경하는 것입니다. 실내에서는 지자기 센서가 혼란을 일으킬 수 있는 많은 물질들이 있어 실제 실내에서 지자기 센서를 사용해보면 매우 불안정 합니다. 따라서 이 정보를 모션 캡쳐를 이용하여 보상해주어야 하는 거지요. Pixhawk 내부에서는 우선 북쪽을 지자기 센서를 통해 대충 알아내고, 모션캡쳐로 부터 헤딩 위치 보상을 해주어 동작하도록되어 있습니다.</p>

<pre><code>INAV_DISAB_MOCAP to 1 (disable mocap estimation, go to PARAMETERS-&gt;Position Estimator INAV).  
</code></pre>

<p>다음은 모션 캡쳐 위치 예측 모드를 꺼줍니다. 어? 왜 모션 캡쳐를 사용하여 위치 인식하는 것이 목적인데 모션캡쳐 위치 예측 모드를 꺼야 하냐구요? 저희는 GPS 를 모사하는 것이지 모션캡쳐기반의 위치 인식을 하면 안됩니다. 그러면 모사하는 의미가 없는거지요. 아주 정밀한 위치를 측정해버리기 때문이지요.</p>

<h4 id="step5">Step 5</h4>

<p>자 여기까지 되었으면 드디어 생성된 GPS 데이터를 보내면 됩니다.</p>

<pre><code class="language-c++">mocap_tf_sub = mp_nh.subscribe("/vicon/DJI_450/DJI_450_drop", 1, &amp;MocapFakeGPSPlugin::mocap_tf_cb, this);  
</code></pre>

<p>fcu_url은 /dev/ttyUSB0 이라는 곳으로 연결된 Zigbee와 같은 통신 모듈을 통해 보내라는 것이고, baud rate은 57600으로 하라는 뜻입니다. 이 정보를 pixhawk로 보내는 것이 바로 MAVROS이지요.</p>

<p><img src="../content/images/2016/03/FakeGPS_step4.png" alt=""></p>

<h4 id="nodegraph">Node Graph</h4>

<p>지금까지 설명한 것을 그림으로 그리면 다음과 같습니다.ROS는 이런 그림까지 지원해주니, 전체 시스템을 바라볼때 쉽게 확인할 수 있겠지요? 참 여기서 설명하지 않은 S2<em>drop</em>XXX은 무시하셔도 됩니다.</p>

<p><img src="../content/images/2016/03/FakeGPS_step5.png" alt=""></p>

<h4 id="testresult">Test Result</h4>

<p>모션 캡쳐를 통해 실외 환경을 모사하게 되면 사실 다양한 환경을 직접 만들 수 있다. 그 중 하나가 바로 position estimator이다. Pixhawk의 경우 GPS-INS 방법을 사용하는데, GPS의 EPH 및 EPV에 따라 어느 정도 정밀하게 측정할 수 있는가를 확인할 수 있다. 아래 그림은 이상적인 GPS환경 (EPH: 0.07, EPV: 0.05)인 경우에서의 동작 화면이다.  </p>

<p><img src="../content/images/2016/03/FakeGPS_Result.png" alt=""></p>

<h4 id="reference">Reference</h4>

<ul>
<li><sup id="fnref:1"><a href="index.html#fn:1" rel="footnote">1</a></sup>: <a href="http://">영문버전</a></li>
<li><sup id="fnref:2"><a href="index.html#fn:2" rel="footnote">2</a></sup>: <a href="https://github.com/PX4/Firmware/pull/3768">Pixhawk Reqeust #3768</a></li>
</ul>

<h4 id="">후기</h4>

<p>처음 작성하다 보니, 많은 문제가 있는 것 같습니다. 그리고 Pixhawk에 대한 분석한 내용을 연재로 해볼까 생각이 들었습니다. 저도 잘은 모르지만, 작성하면서 저도 배울 수 있을 것 같네요.</p>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="../author/sungtae/" style="background-image: url(../content/images/2016/03/140901_drone_writer_hei-100x113-1.jpg)"><span class="hidden">SungTae Moon's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="../author/sungtae/">SungTae Moon</a></h4>

                    <p>Read <a href="../author/sungtae/">more posts</a> by this author.</p>
                <div class="author-meta">
                    
                    
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Fake%20GPS&amp;url=http://localhost:2368/fake-gps/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/fake-gps/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:2368/fake-gps/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>

    </article>
</main>

<aside class="read-next">
    <a class="read-next-story no-cover" href="../pixhawk-bunseog/">
        <section class="post">
            <h2>Pixhawk 분석</h2>
            <p>Introduction 안녕하세요 문성태입니다. 요전 포스팅한 글을 써보다가 문득 지금까지 Pixhawk를 분석한 내용을 적어보면 좋을 것 같아서, Pixhawk 분석 연재를…</p>
        </section>
    </a>
    <a class="read-next-story prev no-cover" href="../setting-up-a-ghost-blog-with-github-pages/">
        <section class="post">
            <h2>Setting up a Ghost Blog with Github Pages</h2>
            <p>Install npm 설치 How to setting with github # (in a new tab) get back to the blog folder $ cd…</p>
        </section>
    </a>
</aside>


<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>  


<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'stmoon'; // required: replace example with your forum shortname
    var disqus_identifier = '6';
	 
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        <footer class="site-footer clearfix">
            <section class="copyright"><a href="../">Program Lock</a> © 2016</section>
            <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    

    <script type="text/javascript" src="../assets/js/jquery.fitvids.js?v=bd325a5265"></script>
    <script type="text/javascript" src="../assets/js/index.js?v=bd325a5265"></script>

    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>  

    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>  


    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'stmoon'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
     var s = document.createElement('script'); s.async = true;
     s.type = 'text/javascript';
     s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
     (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
     }());
     </script>

</body>
